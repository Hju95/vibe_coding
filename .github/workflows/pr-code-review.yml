name: PR Auto Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  code-review:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Auto Code Review
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo, number } = context.issue;
          
          // íŒŒì¼ ë³€ê²½ ì‚¬í•­ ê°€ì ¸ì˜¤ê¸°
          const files = await github.rest.pulls.listFiles({
            owner,
            repo,
            pull_number: number,
          });
          
          const reviews = [];
          
          for (const file of files.data) {
            const filename = file.filename;
            const patch = file.patch || '';
            
            // Python íŒŒì¼ ì²´í¬
            if (filename.endsWith('.py')) {
              const pythonIssues = [];
              
              // ê¸°ë³¸ì ì¸ ì½”ë“œ í’ˆì§ˆ ì²´í¬
              if (patch.includes('print(') && !filename.includes('test_')) {
                pythonIssues.push('ğŸš¨ printë¬¸ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. loggingì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.');
              }
              
              if (patch.includes('TODO') || patch.includes('FIXME')) {
                pythonIssues.push('ğŸ“ TODO/FIXME ì½”ë©˜íŠ¸ê°€ ìˆìŠµë‹ˆë‹¤. ì´ìŠˆë¡œ ë“±ë¡í•˜ëŠ” ê²ƒì„ ê³ ë ¤í•´ë³´ì„¸ìš”.');
              }
              
              if (patch.includes('import *')) {
                pythonIssues.push('âš ï¸ wildcard importê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ëª…ì‹œì  importë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.');
              }
              
              // ê¸´ í•¨ìˆ˜ ì²´í¬
              const functionMatches = patch.match(/def\s+\w+/g);
              if (functionMatches && functionMatches.length > 0) {
                const lines = patch.split('\n');
                const addedLines = lines.filter(line => line.startsWith('+')).length;
                if (addedLines > 50) {
                  pythonIssues.push('ğŸ“ í•¨ìˆ˜ê°€ ë„ˆë¬´ ê¸¸ì–´ ë³´ì…ë‹ˆë‹¤. ì‘ì€ í•¨ìˆ˜ë¡œ ë¶„ë¦¬í•˜ëŠ” ê²ƒì„ ê³ ë ¤í•´ë³´ì„¸ìš”.');
                }
              }
              
              if (pythonIssues.length > 0) {
                reviews.push({
                  path: filename,
                  body: `**Python ì½”ë“œ ë¦¬ë·° ê²°ê³¼:**\n\n${pythonIssues.map(issue => `- ${issue}`).join('\n')}\n\n*ìë™ ìƒì„±ëœ ë¦¬ë·°ì…ë‹ˆë‹¤. ğŸ¤–*`
                });
              }
            }
            
            // í…ŒìŠ¤íŠ¸ íŒŒì¼ ì²´í¬
            if (filename.includes('test_') || filename.includes('tests/')) {
              const testIssues = [];
              
              if (!patch.includes('assert') && !patch.includes('self.assert')) {
                testIssues.push('ğŸ§ª í…ŒìŠ¤íŠ¸ assertionì´ ì—†ëŠ” ê²ƒ ê°™ìŠµë‹ˆë‹¤. ì ì ˆí•œ ê²€ì¦ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
              }
              
              if (testIssues.length > 0) {
                reviews.push({
                  path: filename,
                  body: `**í…ŒìŠ¤íŠ¸ ì½”ë“œ ë¦¬ë·° ê²°ê³¼:**\n\n${testIssues.map(issue => `- ${issue}`).join('\n')}\n\n*ìë™ ìƒì„±ëœ ë¦¬ë·°ì…ë‹ˆë‹¤. ğŸ¤–*`
                });
              }
            }
          }
          
          // ì „ì²´ PRì— ëŒ€í•œ ì¼ë°˜ì ì¸ ì½”ë©˜íŠ¸
          const generalComment = `## ğŸ” ìë™ ì½”ë“œ ë¦¬ë·° ê²°ê³¼

          **ë¶„ì„ ì™„ë£Œ:**
          - ì´ ${files.data.length}ê°œ íŒŒì¼ ë³€ê²½
          - ${files.data.filter(f => f.filename.endsWith('.py')).length}ê°œ Python íŒŒì¼
          - ${files.data.filter(f => f.filename.includes('test')).length}ê°œ í…ŒìŠ¤íŠ¸ íŒŒì¼

          **ê¶Œì¥ì‚¬í•­:**
          - [ ] ëª¨ë“  ìƒˆë¡œìš´ ê¸°ëŠ¥ì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ ì¶”ê°€ í™•ì¸
          - [ ] ì½”ë“œ ìŠ¤íƒ€ì¼ ê°€ì´ë“œ ì¤€ìˆ˜ í™•ì¸
          - [ ] ì—ëŸ¬ í•¸ë“¤ë§ ì ì ˆì„± í™•ì¸
          - [ ] ë¬¸ì„œí™” í•„ìš”ì„± ê²€í† 

          ${reviews.length > 0 ? 'êµ¬ì²´ì ì¸ ì½”ë“œ ë¦¬ë·° ì½”ë©˜íŠ¸ê°€ ê°œë³„ íŒŒì¼ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ìë™ ê²€í† ì—ì„œ íŠ¹ë³„í•œ ì´ìŠˆê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. âœ…'}

          ---
          *ìë™ ìƒì„±ëœ ì½”ë“œ ë¦¬ë·°ì…ë‹ˆë‹¤. ğŸ¤–*`;

          // ì¼ë°˜ ì½”ë©˜íŠ¸ ì¶”ê°€
          await github.rest.issues.createComment({
            owner,
            repo,
            issue_number: number,
            body: generalComment
          });
          
          // ê°œë³„ íŒŒì¼ ë¦¬ë·° ì½”ë©˜íŠ¸ ì¶”ê°€
          for (const review of reviews) {
            try {
              await github.rest.pulls.createReviewComment({
                owner,
                repo,
                pull_number: number,
                body: review.body,
                path: review.path,
                line: 1,
                side: 'RIGHT'
              });
            } catch (error) {
              console.log(`íŒŒì¼ ${review.path}ì— ë¦¬ë·° ì½”ë©˜íŠ¸ ì¶”ê°€ ì‹¤íŒ¨:`, error.message);
            }
          } 